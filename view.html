<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello PdT - Visualisation</title>
    <link rel="icon" type="image/svg+xml" href="assets/tooth.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#e6f2f5', 100: '#cce5eb', 200: '#99ccd7', 500: '#004B63', 600: '#003d51' },
                        dental: { avulsion: '#ef4444', restauration: '#22c55e', endo: '#15803d', implant: '#3b82f6', transitoire: '#eab308', definitive: '#0f766e' }
                    }
                }
            }
        }
    </script>
    <style>
        @media print { .no-print { display: none !important; } * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } }
    </style>
</head>
<body class="bg-slate-50 font-sans antialiased min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-primary-500 to-primary-600 no-print shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C9.5 2 7.5 3.5 7 5.5C6.5 7.5 7 9 7 11C7 13 6 15 5.5 17C5 19 5.5 21 7.5 22C9.5 23 10 21 10.5 19C11 17 11.5 15 12 15C12.5 15 13 17 13.5 19C14 21 14.5 23 16.5 22C18.5 21 19 19 18.5 17C18 15 17 13 17 11C17 9 17.5 7.5 17 5.5C16.5 3.5 14.5 2 12 2Z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">Hello <span class="text-primary-100">PdT</span></h1>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="pdfBtn" onclick="showPdfPreview()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-medium flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        PDF
                    </button>
                    <button onclick="window.print()" class="px-4 py-2 bg-white/20 backdrop-blur text-white rounded-lg hover:bg-white/30 transition-colors text-sm font-medium hidden sm:flex">üñ®Ô∏è</button>
                    <a href="index.html" class="px-4 py-2 bg-white text-primary-600 rounded-lg hover:bg-primary-50 transition-colors text-sm font-medium font-semibold hidden sm:flex">‚ûï</a>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-4xl mx-auto w-full px-4 py-8">
        <div id="loadingState" class="flex flex-col items-center justify-center py-16">
            <div class="w-10 h-10 border-4 border-primary-200 border-t-primary-500 rounded-full animate-spin mb-4"></div>
            <p class="text-slate-600">Chargement du plan...</p>
        </div>

        <div id="emptyState" class="hidden text-center py-16">
            <div class="text-6xl mb-4">üìã</div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Plan non trouv√©</h3>
            <p class="text-slate-600 mb-6">Le plan de traitement demand√© n'existe pas.</p>
            <a href="index.html" class="inline-flex px-6 py-3 bg-primary-500 text-white rounded-xl font-semibold hover:bg-primary-600 transition-colors">Cr√©er un nouveau plan</a>
        </div>

        <div id="planContent" class="hidden space-y-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                <h2 id="patientTitle" class="text-2xl font-bold text-slate-900 mb-2">Plan de Traitement</h2>
                <div class="flex flex-wrap gap-4 text-sm text-slate-600">
                    <span id="planDate" class="flex items-center gap-1">üìÖ -</span>
                    <span id="practitionerMeta" class="flex items-center gap-1">üë®‚Äç‚öïÔ∏è <span id="practitionerName">-</span></span>
                    <span id="centerMeta" class="flex items-center gap-1">üè• <span id="centerName">-</span></span>
                </div>
            </div>
            <div id="treatmentSections" class="space-y-4"></div>
        </div>
    </main>

    <footer class="bg-gradient-to-r from-primary-500 to-primary-600 py-6 no-print">
        <div class="text-center text-sm text-primary-100">¬© 2024 <span class="font-semibold text-white">Hello PdT</span></div>
    </footer>

    <!-- PDF Preview Modal -->
    <div id="pdfModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-primary-500 to-primary-600 px-6 py-4 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-white">Aper√ßu PDF</h3>
                <button onclick="closePdfModal()" class="text-white/80 hover:text-white">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-auto p-4 bg-slate-100">
                <div id="pdfPreviewFrame" class="bg-white rounded-lg shadow-md mx-auto" style="max-width: 100%;"></div>
            </div>
            <div class="p-4 bg-white border-t border-slate-200 flex flex-col gap-3">
                <button onclick="sharePdfFile()" class="w-full px-4 py-3 bg-green-500 text-white rounded-xl font-semibold hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                    </svg>
                    Partager via WhatsApp
                </button>
                <div class="flex gap-2">
                    <button onclick="downloadPdf()" class="flex-1 px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-medium hover:bg-slate-200 transition-colors flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        T√©l√©charger
                    </button>
                    <button onclick="closePdfModal()" class="flex-1 px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-medium hover:bg-slate-200 transition-colors">
                        Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="pdfLoadingOverlay" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 shadow-xl text-center">
            <div class="w-12 h-12 border-4 border-primary-200 border-t-primary-500 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-slate-700 font-medium">G√©n√©ration du PDF...</p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

        const app = initializeApp({
            apiKey: "AIzaSyB4oIBIm0pWfs56hU3_R8qye2I_xbT-n9I",
            authDomain: "plan-de-traitement.firebaseapp.com",
            projectId: "plan-de-traitement",
            storageBucket: "plan-de-traitement.firebasestorage.app",
            messagingSenderId: "444243668402",
            appId: "1:444243668402:web:8e19c59ea965c4e84a08ab"
        });
        const db = getFirestore(app);
        const planId = new URLSearchParams(window.location.search).get('id');

        async function loadPlan() {
            if (!planId) { showEmpty(); return; }
            try {
                const docSnap = await getDoc(doc(db, "plansTraitement", planId));
                if (docSnap.exists()) displayPlan(docSnap.data());
                else showEmpty();
            } catch (e) { console.error(e); showEmpty(); }
        }

        function showEmpty() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }

        function displayPlan(data) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('planContent').classList.remove('hidden');

            if (data.patient?.prenom || data.patient?.nom) {
                currentPatientName = `${data.patient.prenom || ''} ${data.patient.nom || ''}`.trim();
                document.getElementById('patientTitle').textContent = currentPatientName;
            }
            if (data.date) {
                document.getElementById('planDate').innerHTML = 'üìÖ ' + new Date(data.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
            }
            if (data.praticien?.nom) document.getElementById('practitionerName').textContent = data.praticien.nom;
            else document.getElementById('practitionerMeta').style.display = 'none';
            if (data.centre?.nom) document.getElementById('centerName').textContent = data.centre.nom;
            else document.getElementById('centerMeta').style.display = 'none';

            let html = '';
            const colors = { avulsion: 'bg-red-500', restauration: 'bg-green-500', endo: 'bg-emerald-700', implant: 'bg-blue-500', transitoire: 'bg-yellow-400 text-slate-900', definitive: 'bg-teal-600' };

            const section = (icon, title, items) => {
                const valid = items.filter(i => i);
                if (!valid.length) return '';
                return `<div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2"><span class="text-xl">${icon}</span>${title}</h3>
                    <div class="space-y-3">${valid.join('')}</div>
                </div>`;
            };

            const check = (label, val) => val === undefined ? '' : `<div class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl"><span class="w-6 h-6 rounded-full ${val ? 'bg-green-500' : 'bg-slate-300'} text-white flex items-center justify-center text-sm">${val ? '‚úì' : '‚úó'}</span><span>${label}</span></div>`;
            const teeth = (label, arr, type) => {
                if (!arr?.length) return '';
                const badges = arr.map(t => `<span class="w-8 h-8 rounded-full ${colors[type]} text-white flex items-center justify-center text-sm font-semibold">${t}</span>`).join('');
                return `<div class="p-3 bg-slate-50 rounded-xl"><p class="font-medium text-slate-700 mb-2">${label}</p><div class="flex flex-wrap gap-1">${badges}</div></div>`;
            };

            html += section('üßΩ', '1. Assainissement', [check('D√©tartrage', data.detartrage), teeth('Avulsions', data.avulsions, 'avulsion')]);
            html += section('ü™•', '2. Soins conservateurs', [teeth('Restaurations', data.restaurations, 'restauration'), teeth('Traitements endodontiques', data.endo, 'endo')]);
            html += section('üîß', '3. Soins compl√©mentaires', [teeth('Implants', data.implants, 'implant'), teeth('Parodontologie', data.parodonto, 'implant')]);
            html += section('ü¶∑', '4. Proth√®ses transitoires', [check('Proth√®ses transitoires', data.transitoires === 'oui'), teeth('Dents', data.protheses_transitoires, 'transitoire')]);

            if (data.protheses_definitives) {
                const pd = data.protheses_definitives;
                html += section('üëë', '5. Proth√®ses d√©finitives', [
                    check('Inlay Core', pd.inlay_core), teeth('', pd.inlay_core_dents, 'definitive'),
                    check('Couronnes', pd.couronne), teeth('', pd.couronne_dents, 'definitive'),
                    check('Inlay/Onlay', pd.onlay), teeth('', pd.onlay_dents, 'definitive'),
                    check('Proth√®ses amovibles', pd.prothese_amovible), teeth('', pd.prothese_amovible_dents, 'definitive')
                ]);
            }

            if (data.screenshot) {
                html += `<div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">ü©ª 6. Radiographies</h3>
                    <img src="${data.screenshot}" class="rounded-xl max-w-full border border-slate-200" alt="Radiographie">
                </div>`;
            }

            if (data.uploadedFiles?.length) {
                const files = data.uploadedFiles.map(f => `<a href="${f.url}" target="_blank" class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl hover:bg-sky-50 hover:text-sky-600 transition-colors">üìé ${f.name}</a>`).join('');
                html += `<div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">üìé 7. Pi√®ces jointes</h3>
                    <div class="space-y-2">${files}</div>
                </div>`;
            }

            if (data.notes?.trim()) {
                html += `<div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">üìù 8. Notes</h3>
                    <p class="text-slate-700 whitespace-pre-wrap bg-slate-50 p-4 rounded-xl">${data.notes.replace(/</g, '&lt;')}</p>
                </div>`;
            }

            document.getElementById('treatmentSections').innerHTML = html;
        }

        // Store patient data globally for sharing
        let currentPatientName = 'Patient';
        let currentPdfBlob = null;
        let currentPdfDataUrl = null;

        loadPlan();

        // Show PDF preview
        window.showPdfPreview = async function() {
            const loadingOverlay = document.getElementById('pdfLoadingOverlay');
            loadingOverlay.classList.remove('hidden');

            try {
                await generatePdf();
                loadingOverlay.classList.add('hidden');

                // Show preview
                const pdfModal = document.getElementById('pdfModal');
                const previewFrame = document.getElementById('pdfPreviewFrame');

                if (currentPdfDataUrl) {
                    // Show PDF as image preview
                    previewFrame.innerHTML = `<img src="${currentPdfDataUrl}" alt="Aper√ßu PDF" class="w-full rounded-lg">`;
                }

                pdfModal.classList.remove('hidden');
            } catch (err) {
                loadingOverlay.classList.add('hidden');
                alert('Erreur lors de la g√©n√©ration du PDF');
                console.error(err);
            }
        };

        // Generate PDF from content
        async function generatePdf() {
            const { jsPDF } = window.jspdf;
            const planContent = document.getElementById('planContent');

            if (!planContent) return;

            // Capture the content
            const canvas = await html2canvas(planContent, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#f8fafc'
            });

            const imgData = canvas.toDataURL('image/png');
            currentPdfDataUrl = imgData;

            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgWidth = 190;
            const pageHeight = 277;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            let heightLeft = imgHeight;
            let position = 10;

            // Add header
            pdf.setFillColor(0, 75, 99);
            pdf.rect(0, 0, 210, 25, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(18);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Hello PdT', 15, 16);
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.text('Plan de Traitement Dentaire', 60, 16);

            position = 35;

            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= (pageHeight - position);

            while (heightLeft > 0) {
                pdf.addPage();
                position = heightLeft - imgHeight + 10;
                pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            // Generate blob
            currentPdfBlob = pdf.output('blob');

            return pdf;
        }

        // Download PDF
        window.downloadPdf = async function() {
            if (!currentPdfBlob) {
                await generatePdf();
            }

            const fileName = `Plan_Traitement_${currentPatientName.replace(/\s+/g, '_')}.pdf`;
            const url = URL.createObjectURL(currentPdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // Share PDF file
        window.sharePdfFile = async function() {
            if (!currentPdfBlob) {
                await generatePdf();
            }

            const fileName = `Plan_Traitement_${currentPatientName.replace(/\s+/g, '_')}.pdf`;
            const file = new File([currentPdfBlob], fileName, { type: 'application/pdf' });

            // Check if Web Share API with files is supported
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: `Plan de Traitement - ${currentPatientName}`,
                        text: `Plan de traitement dentaire de ${currentPatientName}`
                    });
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        // Fallback to download
                        downloadPdf();
                    }
                }
            } else {
                // Fallback: download and show WhatsApp link
                downloadPdf();
                const shareUrl = window.location.href;
                const message = `Plan de Traitement - ${currentPatientName}\n\nLe PDF a √©t√© t√©l√©charg√©. Vous pouvez aussi consulter en ligne :\n${shareUrl}`;
                const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
            }
        };

        // Close PDF modal
        window.closePdfModal = function() {
            document.getElementById('pdfModal').classList.add('hidden');
        };

        // Close modal on backdrop click
        document.getElementById('pdfModal').addEventListener('click', (e) => {
            if (e.target.id === 'pdfModal') closePdfModal();
        });
    </script>
</body>
</html>
