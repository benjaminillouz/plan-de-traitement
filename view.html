<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan de Traitement - Visualisation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ü¶∑</text></svg>">
    <style>
        .view-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .plan-header {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .plan-info h2 {
            margin: 0 0 0.5rem;
            color: var(--text-primary);
        }

        .plan-meta {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .plan-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .treatment-section {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            margin-bottom: 1rem;
        }

        .treatment-section-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
        }

        .treatment-section-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .treatment-content {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .treatment-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-color);
            border-radius: var(--radius-md);
        }

        .treatment-item-icon {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 1rem;
        }

        .treatment-item-icon.checked {
            background: var(--success-color);
            color: white;
        }

        .treatment-item-icon.unchecked {
            background: var(--border-color);
            color: var(--text-muted);
        }

        .teeth-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .tooth-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 0.85rem;
            font-weight: 600;
            color: white;
        }

        .tooth-badge.avulsion { background: var(--tooth-avulsion); }
        .tooth-badge.restauration { background: var(--tooth-restauration); }
        .tooth-badge.endo { background: var(--tooth-endo); }
        .tooth-badge.implant { background: var(--tooth-implant); }
        .tooth-badge.transitoire { background: var(--tooth-transitoire); color: var(--text-primary); }
        .tooth-badge.definitive { background: var(--tooth-definitive); }

        .screenshot-container {
            margin-top: 1rem;
        }

        .screenshot-container img {
            max-width: 100%;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .files-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .file-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-color);
            border-radius: var(--radius-md);
            text-decoration: none;
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .file-link:hover {
            background: var(--primary-light);
            color: var(--primary-color);
        }

        .notes-content {
            padding: 1rem;
            background: var(--bg-color);
            border-radius: var(--radius-md);
            white-space: pre-wrap;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 4rem;
        }

        .print-actions {
            display: flex;
            gap: 0.5rem;
        }

        @media print {
            .app-header, .app-footer, .print-actions {
                display: none !important;
            }
            .main-content {
                padding: 0;
            }
            .treatment-section {
                box-shadow: none;
                border: 1px solid #ddd;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo-section">
                    <span class="logo-icon">ü¶∑</span>
                    <h1>Plan de Traitement</h1>
                </div>
                <div class="print-actions">
                    <button onclick="window.print()" class="btn btn-secondary">
                        <span class="btn-icon">üñ®Ô∏è</span>
                        Imprimer
                    </button>
                    <a href="index.html" class="btn btn-primary">
                        <span class="btn-icon">‚ûï</span>
                        Nouveau
                    </a>
                </div>
            </div>
        </header>

        <!-- Contenu principal -->
        <main class="main-content">
            <div class="view-container">
                <!-- √âtat de chargement -->
                <div id="loadingState" class="loading-state">
                    <div class="loader"></div>
                    <p>Chargement du plan de traitement...</p>
                </div>

                <!-- √âtat vide / erreur -->
                <div id="emptyState" class="empty-state hidden">
                    <div class="empty-state-icon">üìã</div>
                    <h3>Plan non trouv√©</h3>
                    <p>Le plan de traitement demand√© n'existe pas ou a √©t√© supprim√©.</p>
                    <a href="index.html" class="btn btn-primary" style="margin-top: 1rem;">
                        Cr√©er un nouveau plan
                    </a>
                </div>

                <!-- Contenu du plan -->
                <div id="planContent" class="hidden">
                    <!-- Header du plan -->
                    <div class="plan-header">
                        <div class="plan-info">
                            <h2 id="patientTitle">Plan de Traitement</h2>
                            <div class="plan-meta">
                                <span class="plan-meta-item">
                                    <span>üìÖ</span>
                                    <span id="planDate">-</span>
                                </span>
                                <span class="plan-meta-item" id="practitionerMeta">
                                    <span>üë®‚Äç‚öïÔ∏è</span>
                                    <span id="practitionerName">-</span>
                                </span>
                                <span class="plan-meta-item" id="centerMeta">
                                    <span>üè•</span>
                                    <span id="centerName">-</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Sections de traitement -->
                    <div id="treatmentSections"></div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p>¬© 2024 CEMEDIS - Plan de Traitement Dentaire</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB4oIBIm0pWfs56hU3_R8qye2I_xbT-n9I",
            authDomain: "plan-de-traitement.firebaseapp.com",
            projectId: "plan-de-traitement",
            storageBucket: "plan-de-traitement.firebasestorage.app",
            messagingSenderId: "444243668402",
            appId: "1:444243668402:web:8e19c59ea965c4e84a08ab"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // R√©cup√©rer l'ID du plan
        const urlParams = new URLSearchParams(window.location.search);
        const planId = urlParams.get('id');

        // √âl√©ments du DOM
        const loadingState = document.getElementById('loadingState');
        const emptyState = document.getElementById('emptyState');
        const planContent = document.getElementById('planContent');
        const treatmentSections = document.getElementById('treatmentSections');

        // Charger le plan
        async function loadPlan() {
            if (!planId) {
                showEmptyState();
                return;
            }

            try {
                const docRef = doc(db, "plansTraitement", planId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    displayPlan(data);
                } else {
                    showEmptyState();
                }
            } catch (error) {
                console.error('Erreur lors du chargement:', error);
                showEmptyState();
            }
        }

        function showEmptyState() {
            loadingState.classList.add('hidden');
            emptyState.classList.remove('hidden');
        }

        function displayPlan(data) {
            loadingState.classList.add('hidden');
            planContent.classList.remove('hidden');

            // Titre patient
            const patientTitle = document.getElementById('patientTitle');
            if (data.patient?.prenom || data.patient?.nom) {
                patientTitle.textContent = `${data.patient.prenom || ''} ${data.patient.nom || ''}`.trim();
            }

            // Date
            const planDate = document.getElementById('planDate');
            if (data.date) {
                planDate.textContent = new Date(data.date).toLocaleDateString('fr-FR', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            // Praticien
            const practitionerName = document.getElementById('practitionerName');
            const practitionerMeta = document.getElementById('practitionerMeta');
            if (data.praticien?.nom) {
                practitionerName.textContent = data.praticien.nom;
            } else {
                practitionerMeta.style.display = 'none';
            }

            // Centre
            const centerName = document.getElementById('centerName');
            const centerMeta = document.getElementById('centerMeta');
            if (data.centre?.nom) {
                centerName.textContent = data.centre.nom;
            } else {
                centerMeta.style.display = 'none';
            }

            // G√©n√©rer les sections
            let sectionsHTML = '';

            // 1. Assainissement
            sectionsHTML += createSection('üßΩ', '1. Assainissement', [
                createCheckItem('D√©tartrage', data.detartrage),
                createTeethItem('Avulsions', data.avulsions, 'avulsion')
            ]);

            // 2. Soins conservateurs
            sectionsHTML += createSection('ü™•', '2. Soins conservateurs', [
                createTeethItem('Restaurations', data.restaurations, 'restauration'),
                createTeethItem('Traitements endodontiques', data.endo, 'endo')
            ]);

            // 3. Soins compl√©mentaires
            sectionsHTML += createSection('üõ†', '3. Soins compl√©mentaires', [
                createTeethItem('Implants', data.implants, 'implant'),
                createTeethItem('Parodontologie', data.parodonto, 'implant')
            ]);

            // 4. Proth√®ses transitoires
            sectionsHTML += createSection('ü¶∑', '4. Proth√®ses transitoires', [
                createCheckItem('Proth√®ses transitoires', data.transitoires === 'oui'),
                createTeethItem('Dents concern√©es', data.protheses_transitoires, 'transitoire')
            ]);

            // 5. Proth√®ses d√©finitives
            const definitiveItems = [];
            if (data.protheses_definitives) {
                definitiveItems.push(
                    createCheckItem('Inlay Core', data.protheses_definitives.inlay_core),
                    createTeethItem('Dents Inlay Core', data.protheses_definitives.inlay_core_dents, 'definitive'),
                    createCheckItem('Couronnes', data.protheses_definitives.couronne),
                    createTeethItem('Dents Couronnes', data.protheses_definitives.couronne_dents, 'definitive'),
                    createCheckItem('Inlay / Onlay', data.protheses_definitives.onlay),
                    createTeethItem('Dents Onlay', data.protheses_definitives.onlay_dents, 'definitive'),
                    createCheckItem('Proth√®ses amovibles', data.protheses_definitives.prothese_amovible),
                    createTeethItem('Dents amovibles', data.protheses_definitives.prothese_amovible_dents, 'definitive')
                );
            }
            sectionsHTML += createSection('üëë', '5. Proth√®ses d√©finitives', definitiveItems);

            // 6. Radiographies
            if (data.screenshot) {
                sectionsHTML += `
                    <div class="treatment-section">
                        <div class="treatment-section-header">
                            <span>ü©ª</span>
                            <h3>6. Radiographies</h3>
                        </div>
                        <div class="screenshot-container">
                            <img src="${data.screenshot}" alt="Capture d'√©cran radiographie">
                        </div>
                    </div>
                `;
            }

            // 7. Pi√®ces jointes
            if (data.uploadedFiles && data.uploadedFiles.length > 0) {
                let filesHTML = '<div class="files-list">';
                data.uploadedFiles.forEach(file => {
                    filesHTML += `
                        <a href="${file.url}" target="_blank" class="file-link">
                            <span>üìé</span>
                            <span>${file.name}</span>
                        </a>
                    `;
                });
                filesHTML += '</div>';

                sectionsHTML += `
                    <div class="treatment-section">
                        <div class="treatment-section-header">
                            <span>üìé</span>
                            <h3>7. Pi√®ces jointes</h3>
                        </div>
                        ${filesHTML}
                    </div>
                `;
            }

            // 8. Notes
            if (data.notes && data.notes.trim()) {
                sectionsHTML += `
                    <div class="treatment-section">
                        <div class="treatment-section-header">
                            <span>üìù</span>
                            <h3>8. Notes compl√©mentaires</h3>
                        </div>
                        <div class="notes-content">${escapeHtml(data.notes)}</div>
                    </div>
                `;
            }

            treatmentSections.innerHTML = sectionsHTML;
        }

        function createSection(icon, title, items) {
            const filteredItems = items.filter(item => item !== '');
            if (filteredItems.length === 0) return '';

            return `
                <div class="treatment-section">
                    <div class="treatment-section-header">
                        <span>${icon}</span>
                        <h3>${title}</h3>
                    </div>
                    <div class="treatment-content">
                        ${filteredItems.join('')}
                    </div>
                </div>
            `;
        }

        function createCheckItem(label, checked) {
            if (checked === undefined) return '';
            return `
                <div class="treatment-item">
                    <span class="treatment-item-icon ${checked ? 'checked' : 'unchecked'}">
                        ${checked ? '‚úì' : '‚úó'}
                    </span>
                    <span>${label}</span>
                </div>
            `;
        }

        function createTeethItem(label, teeth, type) {
            if (!teeth || teeth.length === 0) return '';

            let teethBadges = teeth.map(t =>
                `<span class="tooth-badge ${type}">${t}</span>`
            ).join('');

            return `
                <div class="treatment-item" style="flex-direction: column; align-items: flex-start;">
                    <span style="font-weight: 500; margin-bottom: 0.5rem;">${label}</span>
                    <div class="teeth-list">${teethBadges}</div>
                </div>
            `;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Charger le plan au d√©marrage
        loadPlan();
    </script>
</body>
</html>
