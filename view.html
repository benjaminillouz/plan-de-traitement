<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello PdT - Visualisation</title>
    <link rel="icon" type="image/svg+xml" href="assets/tooth.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="js/dental-chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#e6f2f5', 100: '#cce5eb', 200: '#99ccd7', 500: '#004B63', 600: '#003d51' },
                        dental: { avulsion: '#ef4444', restauration: '#22c55e', endo: '#15803d', implant: '#3b82f6', transitoire: '#eab308', definitive: '#0f766e' }
                    }
                }
            }
        }
    </script>
    <style>
        @media print { .no-print { display: none !important; } * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } }
    </style>
</head>
<body class="bg-slate-50 font-sans antialiased min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-primary-500 to-primary-600 no-print shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C9.5 2 7.5 3.5 7 5.5C6.5 7.5 7 9 7 11C7 13 6 15 5.5 17C5 19 5.5 21 7.5 22C9.5 23 10 21 10.5 19C11 17 11.5 15 12 15C12.5 15 13 17 13.5 19C14 21 14.5 23 16.5 22C18.5 21 19 19 18.5 17C18 15 17 13 17 11C17 9 17.5 7.5 17 5.5C16.5 3.5 14.5 2 12 2Z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-white">Hello <span class="text-primary-100">PdT</span></h1>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="pdfBtn" onclick="showPdfPreview()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm font-medium flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        PDF
                    </button>
                    <button onclick="window.print()" class="px-4 py-2 bg-white/20 backdrop-blur text-white rounded-lg hover:bg-white/30 transition-colors text-sm font-medium hidden sm:flex">üñ®Ô∏è</button>
                    <a href="index.html" class="px-4 py-2 bg-white text-primary-600 rounded-lg hover:bg-primary-50 transition-colors text-sm font-medium font-semibold hidden sm:flex">‚ûï</a>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 max-w-4xl mx-auto w-full px-4 py-8">
        <div id="loadingState" class="flex flex-col items-center justify-center py-16">
            <div class="w-10 h-10 border-4 border-primary-200 border-t-primary-500 rounded-full animate-spin mb-4"></div>
            <p class="text-slate-600">Chargement du plan...</p>
        </div>

        <div id="emptyState" class="hidden text-center py-16">
            <div class="text-6xl mb-4">üìã</div>
            <h3 class="text-xl font-bold text-slate-900 mb-2">Plan non trouv√©</h3>
            <p class="text-slate-600 mb-6">Le plan de traitement demand√© n'existe pas.</p>
            <a href="index.html" class="inline-flex px-6 py-3 bg-primary-500 text-white rounded-xl font-semibold hover:bg-primary-600 transition-colors">Cr√©er un nouveau plan</a>
        </div>

        <div id="planContent" class="hidden space-y-6">
            <div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                <h2 id="patientTitle" class="text-2xl font-bold text-slate-900 mb-2">Plan de Traitement</h2>
                <div class="flex flex-wrap gap-4 text-sm text-slate-600">
                    <span id="planDate" class="flex items-center gap-1">üìÖ -</span>
                    <span id="practitionerMeta" class="flex items-center gap-1">üë®‚Äç‚öïÔ∏è <span id="practitionerName">-</span></span>
                    <span id="centerMeta" class="flex items-center gap-1">üè• <span id="centerName">-</span></span>
                </div>
            </div>
            <div id="treatmentSections" class="space-y-4"></div>
        </div>
    </main>

    <footer class="bg-gradient-to-r from-primary-500 to-primary-600 py-6 no-print">
        <div class="text-center text-sm text-primary-100">¬© 2024 <span class="font-semibold text-white">Hello PdT</span></div>
    </footer>

    <!-- PDF Preview Modal -->
    <div id="pdfModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="bg-gradient-to-r from-primary-500 to-primary-600 px-6 py-4 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-white">Aper√ßu PDF</h3>
                <button onclick="closePdfModal()" class="text-white/80 hover:text-white">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="flex-1 overflow-auto p-4 bg-slate-100">
                <div id="pdfPreviewFrame" class="bg-white rounded-lg shadow-md mx-auto" style="max-width: 100%;"></div>
            </div>
            <div class="p-4 bg-white border-t border-slate-200 flex flex-col gap-3">
                <button onclick="sharePdfFile()" class="w-full px-4 py-3 bg-green-500 text-white rounded-xl font-semibold hover:bg-green-600 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                    </svg>
                    Partager via WhatsApp
                </button>
                <div class="flex gap-2">
                    <button onclick="downloadPdf()" class="flex-1 px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-medium hover:bg-slate-200 transition-colors flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        T√©l√©charger
                    </button>
                    <button onclick="closePdfModal()" class="flex-1 px-4 py-2 bg-slate-100 text-slate-700 rounded-lg font-medium hover:bg-slate-200 transition-colors">
                        Fermer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div id="pdfLoadingOverlay" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 shadow-xl text-center">
            <div class="w-12 h-12 border-4 border-primary-200 border-t-primary-500 rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-slate-700 font-medium">G√©n√©ration du PDF...</p>
        </div>
    </div>

    <!-- P2P Share Modal -->
    <div id="p2pShareModal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full overflow-hidden">
            <div class="bg-gradient-to-r from-green-500 to-green-600 px-6 py-4 flex items-center justify-between">
                <h3 class="text-lg font-semibold text-white">Partager via WhatsApp</h3>
                <button onclick="closeP2pModal()" class="text-white/80 hover:text-white">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <!-- Waiting for connection -->
                <div id="p2pWaiting" class="text-center">
                    <p class="text-slate-600 mb-4">Scannez ce QR code avec votre t√©l√©phone pour recevoir le PDF</p>
                    <div id="p2pQrContainer" class="flex justify-center mb-4">
                        <div class="bg-white p-3 rounded-xl shadow-md border border-slate-200"></div>
                    </div>
                    <div class="flex items-center justify-center gap-2 text-sm text-slate-500">
                        <div class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></div>
                        En attente de connexion...
                    </div>
                </div>

                <!-- Connected - Sending -->
                <div id="p2pSending" class="hidden text-center">
                    <div class="w-16 h-16 border-4 border-green-200 border-t-green-500 rounded-full animate-spin mx-auto mb-4"></div>
                    <p class="text-slate-700 font-medium">Envoi du PDF en cours...</p>
                </div>

                <!-- Sent successfully -->
                <div id="p2pSent" class="hidden text-center">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    <p class="text-slate-700 font-medium mb-2">PDF envoy√© !</p>
                    <p class="text-slate-500 text-sm">Le PDF est maintenant sur votre t√©l√©phone. Vous pouvez le partager via WhatsApp.</p>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-200">
                <button onclick="closeP2pModal()" class="w-full px-4 py-2 bg-slate-200 text-slate-700 rounded-lg font-medium hover:bg-slate-300 transition-colors">
                    Fermer
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden PDF render container (desktop format) -->
    <div id="pdfRenderContainer" style="position: absolute; left: -9999px; top: 0; width: 800px; background: white;"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-firestore.js";

        const app = initializeApp({
            apiKey: "AIzaSyB4oIBIm0pWfs56hU3_R8qye2I_xbT-n9I",
            authDomain: "plan-de-traitement.firebaseapp.com",
            projectId: "plan-de-traitement",
            storageBucket: "plan-de-traitement.firebasestorage.app",
            messagingSenderId: "444243668402",
            appId: "1:444243668402:web:8e19c59ea965c4e84a08ab"
        });
        const db = getFirestore(app);
        const planId = new URLSearchParams(window.location.search).get('id');

        async function loadPlan() {
            if (!planId) { showEmpty(); return; }
            try {
                const docSnap = await getDoc(doc(db, "plansTraitement", planId));
                if (docSnap.exists()) displayPlan(docSnap.data());
                else showEmpty();
            } catch (e) { console.error(e); showEmpty(); }
        }

        function showEmpty() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('emptyState').classList.remove('hidden');
        }

        function displayPlan(data) {
            // Store raw data for PDF generation
            currentPlanData = data;

            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('planContent').classList.remove('hidden');

            if (data.patient?.prenom || data.patient?.nom) {
                currentPatientName = `${data.patient.prenom || ''} ${data.patient.nom || ''}`.trim();
                document.getElementById('patientTitle').textContent = currentPatientName;
            }
            if (data.date) {
                document.getElementById('planDate').innerHTML = 'üìÖ ' + new Date(data.date).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
            }
            if (data.praticien?.nom) document.getElementById('practitionerName').textContent = data.praticien.nom;
            else document.getElementById('practitionerMeta').style.display = 'none';
            if (data.centre?.nom) document.getElementById('centerName').textContent = data.centre.nom;
            else document.getElementById('centerMeta').style.display = 'none';

            let html = '';
            const colors = { avulsion: 'bg-red-500', restauration: 'bg-green-500', endo: 'bg-emerald-700', implant: 'bg-blue-500', transitoire: 'bg-yellow-400 text-slate-900', definitive: 'bg-teal-600' };

            const section = (icon, title, items) => {
                const valid = items.filter(i => i);
                if (!valid.length) return '';
                return `<div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4 flex items-center gap-2"><span class="text-xl">${icon}</span>${title}</h3>
                    <div class="space-y-3">${valid.join('')}</div>
                </div>`;
            };

            const check = (label, val) => val === undefined ? '' : `<div class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl"><span class="w-6 h-6 rounded-full ${val ? 'bg-green-500' : 'bg-slate-300'} text-white flex items-center justify-center text-sm">${val ? '‚úì' : '‚úó'}</span><span>${label}</span></div>`;
            const teeth = (label, arr, type) => {
                if (!arr?.length) return '';
                const badges = arr.map(t => `<span class="w-8 h-8 rounded-full ${colors[type]} text-white flex items-center justify-center text-sm font-semibold">${t}</span>`).join('');
                return `<div class="p-3 bg-slate-50 rounded-xl"><p class="font-medium text-slate-700 mb-2">${label}</p><div class="flex flex-wrap gap-1">${badges}</div></div>`;
            };

            html += section('üßΩ', '1. Assainissement', [check('D√©tartrage', data.detartrage), teeth('Avulsions', data.avulsions, 'avulsion')]);
            html += section('ü™•', '2. Soins conservateurs', [teeth('Restaurations', data.restaurations, 'restauration'), teeth('Traitements endodontiques', data.endo, 'endo')]);
            html += section('üîß', '3. Soins compl√©mentaires', [teeth('Implants', data.implants, 'implant'), teeth('Parodontologie', data.parodonto, 'implant')]);
            html += section('ü¶∑', '4. Proth√®ses transitoires', [check('Proth√®ses transitoires', data.transitoires === 'oui'), teeth('Dents', data.protheses_transitoires, 'transitoire')]);

            if (data.protheses_definitives) {
                const pd = data.protheses_definitives;
                html += section('üëë', '5. Proth√®ses d√©finitives', [
                    check('Inlay Core', pd.inlay_core), teeth('', pd.inlay_core_dents, 'definitive'),
                    check('Couronnes', pd.couronne), teeth('', pd.couronne_dents, 'definitive'),
                    check('Inlay/Onlay', pd.onlay), teeth('', pd.onlay_dents, 'definitive'),
                    check('Proth√®ses amovibles', pd.prothese_amovible), teeth('', pd.prothese_amovible_dents, 'definitive')
                ]);
            }

            if (data.screenshot) {
                html += `<div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">ü©ª 6. Radiographies</h3>
                    <img src="${data.screenshot}" class="rounded-xl max-w-full border border-slate-200" alt="Radiographie">
                </div>`;
            }

            if (data.uploadedFiles?.length) {
                const files = data.uploadedFiles.map(f => `<a href="${f.url}" target="_blank" class="flex items-center gap-2 p-3 bg-slate-50 rounded-xl hover:bg-sky-50 hover:text-sky-600 transition-colors">üìé ${f.name}</a>`).join('');
                html += `<div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">üìé 7. Pi√®ces jointes</h3>
                    <div class="space-y-2">${files}</div>
                </div>`;
            }

            if (data.notes?.trim()) {
                html += `<div class="bg-white rounded-2xl p-6 shadow-sm border border-slate-200">
                    <h3 class="text-lg font-semibold text-slate-900 mb-4">üìù 8. Notes</h3>
                    <p class="text-slate-700 whitespace-pre-wrap bg-slate-50 p-4 rounded-xl">${data.notes.replace(/</g, '&lt;')}</p>
                </div>`;
            }

            document.getElementById('treatmentSections').innerHTML = html;
        }

        // Store patient data globally for sharing
        let currentPatientName = 'Patient';
        let currentPlanData = null;
        let currentPdfBlob = null;
        let currentPdfDataUrl = null;

        loadPlan();

        // Show PDF preview
        window.showPdfPreview = async function() {
            const loadingOverlay = document.getElementById('pdfLoadingOverlay');
            loadingOverlay.classList.remove('hidden');

            try {
                await generatePdf();
                loadingOverlay.classList.add('hidden');

                // Show preview
                const pdfModal = document.getElementById('pdfModal');
                const previewFrame = document.getElementById('pdfPreviewFrame');

                if (currentPdfDataUrl) {
                    // Show PDF as image preview
                    previewFrame.innerHTML = `<img src="${currentPdfDataUrl}" alt="Aper√ßu PDF" class="w-full rounded-lg">`;
                }

                pdfModal.classList.remove('hidden');
            } catch (err) {
                loadingOverlay.classList.add('hidden');
                alert('Erreur lors de la g√©n√©ration du PDF');
                console.error(err);
            }
        };

        // Generate PDF HTML for desktop format
        function generatePdfHtml(data) {
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
            };

            const patientName = `${data.patient?.prenom || ''} ${data.patient?.nom || ''}`.trim() || 'Patient';
            const praticien = data.praticien?.nom || '-';
            const centre = data.centre?.nom || '-';

            let sectionsHtml = '';

            // 1. Assainissement
            if (data.detartrage || data.avulsions?.length > 0) {
                sectionsHtml += `
                    <div class="section">
                        <h3>1. Assainissement</h3>
                        <div class="section-content">
                            ${data.detartrage ? '<p>‚úì D√©tartrage</p>' : ''}
                            ${data.avulsions?.length > 0 ? `<p>‚úì Avulsions dentaires : <strong>${data.avulsions.join(', ')}</strong></p>` : ''}
                        </div>
                    </div>
                `;
            }

            // 2. Soins conservateurs
            if (data.restaurations?.length > 0 || data.endo?.length > 0) {
                sectionsHtml += `
                    <div class="section">
                        <h3>2. Soins conservateurs</h3>
                        <div class="section-content">
                            ${data.restaurations?.length > 0 ? `<p>‚úì Restaurations : <strong>${data.restaurations.join(', ')}</strong></p>` : ''}
                            ${data.endo?.length > 0 ? `<p>‚úì Traitements endodontiques : <strong>${data.endo.join(', ')}</strong></p>` : ''}
                        </div>
                    </div>
                `;
            }

            // 3. Soins compl√©mentaires
            if (data.implants?.length > 0 || data.parodonto?.length > 0) {
                sectionsHtml += `
                    <div class="section">
                        <h3>3. Soins compl√©mentaires</h3>
                        <div class="section-content">
                            ${data.implants?.length > 0 ? `<p>‚úì Pose d'implants : <strong>${data.implants.join(', ')}</strong></p>` : ''}
                            ${data.parodonto?.length > 0 ? `<p>‚úì Parodontologie : <strong>${data.parodonto.join(', ')}</strong></p>` : ''}
                        </div>
                    </div>
                `;
            }

            // 4. Proth√®ses transitoires
            if (data.transitoires === 'oui' || data.protheses_transitoires?.length > 0) {
                sectionsHtml += `
                    <div class="section">
                        <h3>4. Proth√®ses transitoires</h3>
                        <div class="section-content">
                            <p>‚úì Oui${data.protheses_transitoires?.length > 0 ? ` : <strong>${data.protheses_transitoires.join(', ')}</strong>` : ''}</p>
                        </div>
                    </div>
                `;
            }

            // 5. Proth√®ses d√©finitives
            if (data.protheses_definitives) {
                const pd = data.protheses_definitives;
                const items = [];
                if (pd.inlay_core) items.push(`Inlay Core${pd.inlay_core_dents?.length ? ' : ' + pd.inlay_core_dents.join(', ') : ''}`);
                if (pd.couronne) items.push(`Couronnes${pd.couronne_dents?.length ? ' : ' + pd.couronne_dents.join(', ') : ''}`);
                if (pd.onlay) items.push(`Inlay/Onlay${pd.onlay_dents?.length ? ' : ' + pd.onlay_dents.join(', ') : ''}`);
                if (pd.prothese_amovible) items.push(`Proth√®ses amovibles${pd.prothese_amovible_dents?.length ? ' : ' + pd.prothese_amovible_dents.join(', ') : ''}`);

                if (items.length > 0) {
                    sectionsHtml += `
                        <div class="section">
                            <h3>5. Proth√®ses d√©finitives</h3>
                            <div class="section-content">
                                ${items.map(item => `<p>‚úì ${item}</p>`).join('')}
                            </div>
                        </div>
                    `;
                }
            }

            // 6. Radiographies
            if (data.screenshot || data.radiographies?.length > 0) {
                let radioHtml = '';
                if (data.screenshot) {
                    radioHtml += `<img src="${data.screenshot}" style="max-width: 100%; border-radius: 8px; margin-bottom: 10px;">`;
                }
                if (data.radiographies?.length > 0) {
                    radioHtml += `<div style="display: flex; flex-wrap: wrap; gap: 10px;">
                        ${data.radiographies.map(r => `<img src="${r.data}" style="max-width: 200px; border-radius: 8px;">`).join('')}
                    </div>`;
                }
                sectionsHtml += `
                    <div class="section">
                        <h3>6. Radiographies</h3>
                        <div class="section-content">${radioHtml}</div>
                    </div>
                `;
            }

            // 7. Photos
            if (data.photos?.length > 0) {
                sectionsHtml += `
                    <div class="section">
                        <h3>7. Photographies</h3>
                        <div class="section-content">
                            <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                                ${data.photos.map(p => `<img src="${p.data}" style="max-width: 200px; border-radius: 8px;">`).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            // 8. Notes
            if (data.notes?.trim()) {
                sectionsHtml += `
                    <div class="section">
                        <h3>8. Notes</h3>
                        <div class="section-content">
                            <p style="white-space: pre-wrap; background: #f8fafc; padding: 15px; border-radius: 8px;">${data.notes.replace(/</g, '&lt;')}</p>
                        </div>
                    </div>
                `;
            }

            // Generate dental chart if available
            let dentalChartHtml = '';
            if (window.generateDentalChartForPDF) {
                // Build selections object from stored data
                const selections = {
                    avulsions: data.avulsions || [],
                    restaurations: data.restaurations || [],
                    endo: data.endo || [],
                    implants: data.implants || [],
                    parodonto: data.parodonto || [],
                    protheses_transitoires: data.protheses_transitoires || [],
                    protheses_definitives: {
                        inlay_core: data.protheses_definitives?.inlay_core_dents || [],
                        couronnes: data.protheses_definitives?.couronne_dents || [],
                        onlay: data.protheses_definitives?.onlay_dents || [],
                        amovibles: data.protheses_definitives?.prothese_amovible_dents || []
                    }
                };

                const chartHtml = window.generateDentalChartForPDF(selections);
                if (chartHtml) {
                    dentalChartHtml = `
                        <div class="section">
                            <h3>Sch√©ma Dentaire</h3>
                            <div class="section-content" style="padding: 10px;">
                                ${chartHtml}
                            </div>
                        </div>
                    `;
                }
            }

            return `
                <style>
                    .pdf-content {
                        font-family: 'Inter', Arial, sans-serif;
                        padding: 40px;
                        color: #1e293b;
                        background: white;
                    }
                    .pdf-header {
                        background: linear-gradient(135deg, #004B63, #003d51);
                        color: white;
                        padding: 30px;
                        margin: -40px -40px 30px -40px;
                    }
                    .pdf-logo {
                        font-size: 28px;
                        font-weight: 700;
                        margin-bottom: 5px;
                    }
                    .pdf-logo span { opacity: 0.8; }
                    .pdf-subtitle { font-size: 14px; opacity: 0.9; }
                    .pdf-date { font-size: 13px; opacity: 0.8; margin-top: 10px; }
                    .patient-info {
                        background: #f8fafc;
                        border: 1px solid #e2e8f0;
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 25px;
                    }
                    .patient-info h4 {
                        color: #004B63;
                        font-size: 14px;
                        font-weight: 600;
                        margin: 0 0 15px 0;
                        text-transform: uppercase;
                    }
                    .patient-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 12px;
                    }
                    .patient-field label {
                        font-size: 11px;
                        color: #64748b;
                        display: block;
                        margin-bottom: 2px;
                    }
                    .patient-field span {
                        font-size: 14px;
                        font-weight: 500;
                        color: #1e293b;
                    }
                    .section {
                        margin-bottom: 20px;
                        border: 1px solid #e2e8f0;
                        border-radius: 12px;
                        overflow: hidden;
                    }
                    .section h3 {
                        background: linear-gradient(135deg, #004B63, #006080);
                        color: white;
                        padding: 12px 20px;
                        margin: 0;
                        font-size: 14px;
                        font-weight: 600;
                    }
                    .section-content {
                        padding: 15px 20px;
                    }
                    .section-content p {
                        margin: 8px 0;
                        font-size: 13px;
                        line-height: 1.5;
                    }
                    .section-content strong {
                        color: #004B63;
                    }
                </style>
                <div class="pdf-content">
                    <div class="pdf-header">
                        <div class="pdf-logo">Hello <span>PdT</span></div>
                        <div class="pdf-subtitle">Plan de Traitement Dentaire</div>
                        <div class="pdf-date">Date : ${formatDate(data.date)}</div>
                    </div>
                    <div class="patient-info">
                        <h4>Informations Patient</h4>
                        <div class="patient-grid">
                            <div class="patient-field">
                                <label>Patient</label>
                                <span>${patientName}</span>
                            </div>
                            <div class="patient-field">
                                <label>Praticien</label>
                                <span>${praticien}</span>
                            </div>
                            <div class="patient-field">
                                <label>Centre de soins</label>
                                <span>${centre}</span>
                            </div>
                            <div class="patient-field">
                                <label>Date</label>
                                <span>${formatDate(data.date)}</span>
                            </div>
                        </div>
                    </div>
                    ${dentalChartHtml}
                    ${sectionsHtml || '<p style="text-align: center; color: #94a3b8;">Aucun traitement s√©lectionn√©</p>'}
                </div>
            `;
        }

        // Generate PDF from content
        async function generatePdf() {
            if (!currentPlanData) return;

            const { jsPDF } = window.jspdf;
            const pdfContainer = document.getElementById('pdfRenderContainer');

            // Generate PDF HTML in desktop format
            pdfContainer.innerHTML = generatePdfHtml(currentPlanData);

            // Wait for images to load
            const images = pdfContainer.querySelectorAll('img');
            await Promise.all([...images].map(img => {
                if (img.complete) return Promise.resolve();
                return new Promise(resolve => {
                    img.onload = resolve;
                    img.onerror = resolve;
                });
            }));

            // Capture the content at fixed desktop width
            const canvas = await html2canvas(pdfContainer, {
                scale: 2,
                useCORS: true,
                logging: false,
                backgroundColor: '#ffffff',
                width: 800
            });

            const imgData = canvas.toDataURL('image/png');
            currentPdfDataUrl = imgData;

            const pdf = new jsPDF('p', 'mm', 'a4');
            const imgWidth = 210;
            const pageHeight = 297;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft > 0) {
                pdf.addPage();
                position = heightLeft - imgHeight;
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            // Generate blob
            currentPdfBlob = pdf.output('blob');

            return pdf;
        }

        // Download PDF
        window.downloadPdf = async function() {
            if (!currentPdfBlob) {
                await generatePdf();
            }

            const fileName = `Plan_Traitement_${currentPatientName.replace(/\s+/g, '_')}.pdf`;
            const url = URL.createObjectURL(currentPdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        // P2P sharing state
        let p2pPeer = null;
        let p2pConnection = null;

        // Share PDF file via P2P
        window.sharePdfFile = async function() {
            if (!currentPdfBlob) {
                await generatePdf();
            }

            // On mobile, use native share directly
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            if (isMobile) {
                const fileName = `Plan_Traitement_${currentPatientName.replace(/\s+/g, '_')}.pdf`;
                const file = new File([currentPdfBlob], fileName, { type: 'application/pdf' });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: `Plan de Traitement - ${currentPatientName}`,
                            text: `Plan de traitement dentaire - ${currentPatientName}`
                        });
                        return;
                    } catch (err) {
                        if (err.name === 'AbortError') return;
                    }
                }
                // Fallback for mobile
                downloadPdf();
                return;
            }

            // On desktop, use P2P QR code transfer
            initP2pShare();
        };

        // Initialize P2P sharing
        async function initP2pShare() {
            // Close PDF modal first
            closePdfModal();

            // Show P2P modal
            const modal = document.getElementById('p2pShareModal');
            modal.classList.remove('hidden');

            // Reset states
            document.getElementById('p2pWaiting').classList.remove('hidden');
            document.getElementById('p2pSending').classList.add('hidden');
            document.getElementById('p2pSent').classList.add('hidden');

            // Clean up previous peer
            if (p2pPeer) {
                p2pPeer.destroy();
            }

            try {
                // Create new peer
                p2pPeer = new Peer();

                p2pPeer.on('open', (id) => {
                    console.log('P2P Peer ID:', id);

                    // Generate QR code with share URL
                    const baseUrl = window.location.origin;
                    const shareUrl = `${baseUrl}/share.html?peer=${id}`;

                    const qrContainer = document.getElementById('p2pQrContainer');
                    qrContainer.innerHTML = '<div class="bg-white p-3 rounded-xl shadow-md border border-slate-200"></div>';

                    new QRCode(qrContainer.firstChild, {
                        text: shareUrl,
                        width: 180,
                        height: 180,
                        colorDark: '#25D366',
                        colorLight: '#ffffff',
                        correctLevel: QRCode.CorrectLevel.M
                    });
                });

                p2pPeer.on('connection', async (conn) => {
                    console.log('Mobile connected');
                    p2pConnection = conn;

                    conn.on('open', async () => {
                        // Show sending state
                        document.getElementById('p2pWaiting').classList.add('hidden');
                        document.getElementById('p2pSending').classList.remove('hidden');

                        // Convert PDF blob to base64
                        const arrayBuffer = await currentPdfBlob.arrayBuffer();
                        const base64Pdf = btoa(
                            new Uint8Array(arrayBuffer).reduce((data, byte) => data + String.fromCharCode(byte), '')
                        );

                        // Send PDF data
                        const fileName = `Plan_Traitement_${currentPatientName.replace(/\s+/g, '_')}.pdf`;
                        conn.send({
                            type: 'pdf',
                            data: base64Pdf,
                            filename: fileName,
                            patientName: currentPatientName
                        });

                        // Show success after a short delay
                        setTimeout(() => {
                            document.getElementById('p2pSending').classList.add('hidden');
                            document.getElementById('p2pSent').classList.remove('hidden');
                        }, 1000);
                    });

                    conn.on('error', (err) => {
                        console.error('P2P connection error:', err);
                    });
                });

                p2pPeer.on('error', (err) => {
                    console.error('P2P peer error:', err);
                });

            } catch (err) {
                console.error('P2P init error:', err);
            }
        }

        // Close P2P modal
        window.closeP2pModal = function() {
            document.getElementById('p2pShareModal').classList.add('hidden');
            if (p2pConnection) {
                p2pConnection.close();
                p2pConnection = null;
            }
            if (p2pPeer) {
                p2pPeer.destroy();
                p2pPeer = null;
            }
        };

        // Close PDF modal
        window.closePdfModal = function() {
            document.getElementById('pdfModal').classList.add('hidden');
        };

        // Close modals on backdrop click
        document.getElementById('pdfModal').addEventListener('click', (e) => {
            if (e.target.id === 'pdfModal') closePdfModal();
        });
        document.getElementById('p2pShareModal').addEventListener('click', (e) => {
            if (e.target.id === 'p2pShareModal') closeP2pModal();
        });
    </script>
</body>
</html>
