<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello PdT - Réception PDF</title>
    <link rel="icon" type="image/svg+xml" href="assets/tooth.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#e6f2f5', 100: '#cce5eb', 200: '#99ccd7', 500: '#004B63', 600: '#003d51' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-slate-50 font-sans antialiased min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-primary-500 to-primary-600 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 backdrop-blur rounded-xl flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2C9.5 2 7.5 3.5 7 5.5C6.5 7.5 7 9 7 11C7 13 6 15 5.5 17C5 19 5.5 21 7.5 22C9.5 23 10 21 10.5 19C11 17 11.5 15 12 15C12.5 15 13 17 13.5 19C14 21 14.5 23 16.5 22C18.5 21 19 19 18.5 17C18 15 17 13 17 11C17 9 17.5 7.5 17 5.5C16.5 3.5 14.5 2 12 2Z"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white">Hello <span class="text-primary-100">PdT</span></h1>
                    <p class="text-xs text-primary-100">Réception PDF</p>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 flex items-center justify-center p-4">
        <!-- Connecting State -->
        <div id="connectingState" class="text-center">
            <div class="w-16 h-16 border-4 border-primary-200 border-t-primary-500 rounded-full animate-spin mx-auto mb-6"></div>
            <h2 class="text-xl font-bold text-slate-900 mb-2">Connexion en cours...</h2>
            <p class="text-slate-600">Établissement de la connexion avec l'ordinateur</p>
        </div>

        <!-- Receiving State -->
        <div id="receivingState" class="hidden text-center">
            <div class="w-16 h-16 border-4 border-green-200 border-t-green-500 rounded-full animate-spin mx-auto mb-6"></div>
            <h2 class="text-xl font-bold text-slate-900 mb-2">Réception du PDF...</h2>
            <p class="text-slate-600">Transfert en cours, veuillez patienter</p>
        </div>

        <!-- Received State -->
        <div id="receivedState" class="hidden text-center max-w-md mx-auto">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
            </div>
            <h2 class="text-xl font-bold text-slate-900 mb-2">PDF reçu !</h2>
            <p id="patientName" class="text-slate-600 mb-6">Plan de traitement</p>

            <div class="space-y-3">
                <button onclick="shareViaWhatsApp()" class="w-full px-6 py-4 bg-green-500 text-white rounded-xl font-semibold hover:bg-green-600 transition-colors flex items-center justify-center gap-3">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                    </svg>
                    Partager via WhatsApp
                </button>

                <button onclick="shareNative()" class="w-full px-6 py-3 bg-primary-500 text-white rounded-xl font-semibold hover:bg-primary-600 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                    </svg>
                    Autres options de partage
                </button>

                <button onclick="downloadPdf()" class="w-full px-6 py-3 bg-slate-100 text-slate-700 rounded-xl font-medium hover:bg-slate-200 transition-colors flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Télécharger le PDF
                </button>
            </div>
        </div>

        <!-- Error State -->
        <div id="errorState" class="hidden text-center max-w-md mx-auto">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </div>
            <h2 class="text-xl font-bold text-slate-900 mb-2">Erreur de connexion</h2>
            <p class="text-slate-600 mb-6">Impossible de se connecter. Veuillez réessayer.</p>
            <button onclick="retry()" class="px-6 py-3 bg-primary-500 text-white rounded-xl font-semibold hover:bg-primary-600 transition-colors">
                Réessayer
            </button>
        </div>

        <!-- No Peer State -->
        <div id="noPeerState" class="hidden text-center max-w-md mx-auto">
            <div class="w-20 h-20 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <svg class="w-10 h-10 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h2 class="text-xl font-bold text-slate-900 mb-2">Lien invalide</h2>
            <p class="text-slate-600 mb-6">Ce lien ne contient pas d'identifiant de connexion valide.</p>
            <a href="index.html" class="inline-block px-6 py-3 bg-primary-500 text-white rounded-xl font-semibold hover:bg-primary-600 transition-colors">
                Accueil
            </a>
        </div>
    </main>

    <script>
        // State
        let pdfBlob = null;
        let pdfFileName = 'Plan_Traitement.pdf';
        let patientName = 'Patient';
        let peer = null;
        let connection = null;

        // Get peer ID from URL
        function getPeerId() {
            const params = new URLSearchParams(window.location.search);
            return params.get('peer');
        }

        // Show state
        function showState(stateId) {
            ['connectingState', 'receivingState', 'receivedState', 'errorState', 'noPeerState'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(stateId).classList.remove('hidden');
        }

        // Convert base64 to Blob
        function base64ToBlob(base64, type = 'application/pdf') {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return new Blob([bytes], { type });
        }

        // Initialize connection
        function initConnection() {
            const peerId = getPeerId();

            if (!peerId) {
                showState('noPeerState');
                return;
            }

            showState('connectingState');

            try {
                peer = new Peer();

                peer.on('open', (id) => {
                    console.log('My peer ID:', id);

                    // Connect to the desktop peer
                    connection = peer.connect(peerId);

                    connection.on('open', () => {
                        console.log('Connected to desktop');
                    });

                    connection.on('data', (data) => {
                        console.log('Received data:', data.type);

                        if (data.type === 'pdf') {
                            showState('receivingState');

                            // Convert base64 to blob
                            pdfBlob = base64ToBlob(data.data);
                            pdfFileName = data.filename || 'Plan_Traitement.pdf';
                            patientName = data.patientName || 'Patient';

                            // Update UI
                            document.getElementById('patientName').textContent = `Plan de traitement - ${patientName}`;

                            // Show success
                            setTimeout(() => {
                                showState('receivedState');
                            }, 500);
                        }
                    });

                    connection.on('error', (err) => {
                        console.error('Connection error:', err);
                        showState('errorState');
                    });

                    connection.on('close', () => {
                        console.log('Connection closed');
                    });
                });

                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    showState('errorState');
                });

                // Timeout after 30 seconds
                setTimeout(() => {
                    if (!pdfBlob) {
                        showState('errorState');
                    }
                }, 30000);

            } catch (err) {
                console.error('Init error:', err);
                showState('errorState');
            }
        }

        // Share via WhatsApp
        async function shareViaWhatsApp() {
            if (!pdfBlob) return;

            const file = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });

            // Try native share with file
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: `Plan de Traitement - ${patientName}`,
                        text: `Plan de traitement dentaire - ${patientName}`
                    });
                    return;
                } catch (err) {
                    if (err.name === 'AbortError') return;
                    console.log('Native share failed, trying WhatsApp link');
                }
            }

            // Fallback: download and open WhatsApp
            downloadPdf();
            const message = `Plan de Traitement Dentaire - ${patientName}\n\nLe PDF a été téléchargé sur votre appareil.`;
            const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Native share
        async function shareNative() {
            if (!pdfBlob) return;

            const file = new File([pdfBlob], pdfFileName, { type: 'application/pdf' });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: `Plan de Traitement - ${patientName}`
                    });
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        downloadPdf();
                    }
                }
            } else if (navigator.share) {
                try {
                    await navigator.share({
                        title: `Plan de Traitement - ${patientName}`,
                        text: `Plan de traitement dentaire - ${patientName}`
                    });
                } catch (err) {
                    console.log('Share cancelled');
                }
            } else {
                downloadPdf();
            }
        }

        // Download PDF
        function downloadPdf() {
            if (!pdfBlob) return;

            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = pdfFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Retry connection
        function retry() {
            if (peer) {
                peer.destroy();
            }
            initConnection();
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (connection) connection.close();
            if (peer) peer.destroy();
        });

        // Start
        initConnection();
    </script>
</body>
</html>
